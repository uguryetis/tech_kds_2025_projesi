<!DOCTYPE html>
<html lang="tr">
<head>
  <%- include('partials/head', { title }) %>
</head>
<body>
  <div class="wrapper">
    <%- include('partials/nav', { activePage }) %>

    <main class="main-content">
      <h1 class="page-title">Şube Stok Analizi</h1>


      <div class="card">
        <form action="/sube-stok" method="get" class="filter-bar">
          <div class="filter-group">
            <label for="ay">Ay Seç</label>
            <select name="ay" id="ay">
              <% months.forEach((m, index) => { %>
                <option value="<%= index + 1 %>" <%= seciliAy === (index + 1) ? 'selected' : '' %>>
                  <%= m %>
                </option>
              <% }) %>
            </select>
          </div>

      
          <input type="hidden" name="sube1" value="<%= sube1Key %>">
          <input type="hidden" name="sube2" value="<%= sube2Key %>">

          <button type="submit" class="btn-primary">
            <i class="fa-solid fa-filter"></i>
            Verileri Göster
          </button>
        </form>
      </div>

      <div class="card-large-chart">
        <canvas id="stokMonthChart"></canvas>
      </div>

      
      <div class="card" style="margin-top:16px;">
        <form action="/sube-stok" method="get" class="filter-bar">
          <div class="filter-group">
            <label for="sube1">1. Şube</label>
            <select name="sube1" id="sube1">
              <% BRANCHES.forEach(b => { %>
                <option value="<%= b.key %>" <%= sube1Key === b.key ? 'selected' : '' %>>
                  <%= b.name %>
                </option>
              <% }) %>
            </select>
          </div>

          <div class="filter-group">
            <label for="sube2">2. Şube</label>
            <select name="sube2" id="sube2">
              <% BRANCHES.forEach(b => { %>
                <option value="<%= b.key %>" <%= sube2Key === b.key ? 'selected' : '' %>>
                  <%= b.name %>
                </option>
              <% }) %>
            </select>
          </div>

          
          <input type="hidden" name="ay" value="<%= seciliAy %>">

          <button type="submit" class="btn-primary">
            <i class="fa-solid fa-filter"></i>
            Karşılaştır
          </button>
        </form>
      </div>

      <div class="card-large-chart">
        <canvas id="stokCompareChart"></canvas>
      </div>

      <div class="card" style="margin-top:16px;">
        <p style="font-size:14px; color:#b91c1c;">
          Özellikle <strong>Selçuk</strong> şubesinin stok devir hızı diğer şubelere göre daha düşük seyretmektedir.
          Performans odaklı yaklaşımla değerlendirilmesi önerilmektedir.
        </p>
      </div>
    </main>
  </div>

  <script>
  
    const stokMonthLabels = <%- JSON.stringify(barLabels) %>;
    const stokMonthData   = <%- JSON.stringify(barData) %>;
    const stokMonthColors = <%- JSON.stringify(barColors) %>;

    
    const compareLabels = <%- JSON.stringify(compareLabels) %>;
    const ds1           = <%- JSON.stringify(dataset1) %>;
    const ds2           = <%- JSON.stringify(dataset2) %>;

    
    const ctxMonth = document.getElementById('stokMonthChart').getContext('2d');
    new Chart(ctxMonth, {
      type: 'bar',
      data: {
        labels: stokMonthLabels,
        datasets: [{
          label: 'Stokta Kalma Süresi (Gün)',
          data: stokMonthData,
          backgroundColor: stokMonthColors,
          borderColor: stokMonthColors,
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            title: { display: true, text: 'Stokta Kalma Süresi (Gün)' },
            beginAtZero: true
          }
        },
        plugins: {
          legend: { display: false },
          title: {
            display: true,
            text: 'Seçili Ayda Şubelerin Stokta Kalma Süreleri (Gün)'
          },
          tooltip: {
            callbacks: {
              label: function (ctx) {
                return ctx.label + ': ' + ctx.parsed.y + ' gün';
              }
            }
          }
        }
      }
    });

  
    const ctxCompare = document.getElementById('stokCompareChart').getContext('2d');
    new Chart(ctxCompare, {
      type: 'line',
      data: {
        labels: compareLabels,
        datasets: [ds1, ds2]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            title: { display: true, text: 'Stokta Kalma Süresi (Gün)' },
            beginAtZero: true
          }
        },
        plugins: {
          legend: { position: 'bottom' },
          title: {
            display: true,
            text: 'Ocak – Haziran 2025 İki Şube Stok Devir Günü Karşılaştırması'
          },
          tooltip: {
            callbacks: {
              label: function (ctx) {
                return ctx.dataset.label + ': ' + ctx.parsed.y + ' gün';
              }
            }
          }
        }
      }
    });
  </script>
</body>
</html>














